public with sharing class MetadataUtility {
  public static String getSessionIdFromVFPage(PageReference visualforcePage) {
    String content = Test.IsRunningTest() ? 'Start_Of_Session_Id1234567890End_Of_Session_Id' : visualforcePage.getContent().toString();
    Integer s = content.indexOf('Start_Of_Session_Id') + 'Start_Of_Session_Id'.length();
    Integer e = content.indexOf('End_Of_Session_Id');
    return content.substring(s, e);
  }

  public static final List<String> PACKAGE_TYPES = new List<String>{ 'all', 'unmanagedOnly', 'managedOnly' };

  public static final List<String> METADATA_TYPES = new List<String>{
    'ActionLinkGroupTemplate',
    'ActionOverride',
    'AnalyticSnapshot',
    'ApexClass',
    'ApexComponent',
    'ApexPage',
    'ApexTrigger',
    'AppMenu',
    'ApprovalProcess',
    'ArticleType',
    'AssignmentRules',
    'Audience',
    'AuthProvider',
    'AuraDefinitionBundle',
    'AutoResponseRules',
    'BaseSharingRule',
    'Bot',
    'BotVersion',
    'BrandingSet',
    'BusinessProcess',
    'CallCenter',
    'CaseSubjectParticle',
    'Certificate',
    'ChatterExtension',
    'CleanDataService',
    'CMSConnectSource',
    'CompactLayout',
    'Community',
    'CommunityTemplateDefinition',
    'CommunityThemeDefinition',
    'ConnectedApp',
    'ContentAsset',
    'CorsWhitelistOrigin',
    'CriteriaBasedSharingRule',
    'CspTrustedSite',
    'CustomApplication',
    'CustomApplicationComponent',
    'CustomFeedFilter',
    'CustomField',
    'CustomHelpMenuSection',
    'CustomLabels',
    'CustomLabel',
    'CustomMetadataTypes',
    'CustomMetadata',
    'CustomObject',
    'CustomObjectTranslation',
    'CustomPageWebLink',
    'CustomPermission',
    'CustomSite',
    'CustomTab',
    'Dashboard',
    'DataCategoryGroup',
    'DelegateGroup',
    'Document',
    'DuplicateRule',
    'EclairGeoData',
    'EmailServicesFunction',
    'EmailTemplate',
    'EmbeddedServiceBranding',
    'EmbeddedServiceConfig',
    'EmbeddedServiceFlowConfig',
    'EmbeddedServiceLiveAgent',
    'EntitlementProcess',
    'EntitlementTemplate',
    'EventDelivery',
    'EventSubscription',
    'ExternalServiceRegistration',
    'ExternalDataSource',
    'FeatureParameterBoolean',
    'FeatureParameterDate',
    'FeatureParameterInteger',
    'FieldSet',
    'FlexiPage',
    'Flow',
    'FlowCategory',
    'FlowDefinition',
    'Folder',
    'FolderShare',
    'GlobalValueSet',
    'GlobalValueSetTranslation',
    'GlobalPicklistValue',
    'Group',
    'HomePageComponent',
    'HomePageLayout',
    'Index',
    'InstalledPackage',
    'KeywordList',
    'Layout',
    'Letterhead',
    'LightningBolt',
    'LightningComponentBundle',
    'LightningExperienceTheme',
    'ListView',
    'LiveChatAgentConfig',
    'LiveChatButton',
    'LiveChatDeployment',
    'LiveChatSensitiveDataRule',
    'ManagedTopics',
    'MatchingRule',
    'Metadata',
    'MetadataWithContent',
    'MilestoneType',
    'MlDomain',
    'ModerationRule',
    'NamedCredential',
    'NamedFilter',
    'Network',
    'NetworkBranding',
    'OwnerSharingRule',
    'Package',
    'PathAssistant',
    'PermissionSet',
    'Picklist',
    'PlatformCachePartition',
    'PlatformEventChannel',
    'Portal',
    'PostTemplate',
    'PresenceDeclineReason',
    'PresenceUserConfig',
    'Profile',
    'ProfileActionOverride',
    'ProfilePasswordPolicy',
    'ProfileSessionSetting',
    'Queue',
    'QueueRoutingConfig',
    'QuickAction',
    'RecommendationStrategy',
    'RecordActionDeployment',
    'RecordType',
    'RemoteSiteSetting',
    'Report',
    'ReportType',
    'Role',
    'SamlSsoConfig',
    'Scontrol',
    'SearchLayouts',
    'ServiceChannel',
    'ServicePresenceStatus',
    'Settings',
    'SharingBaseRule',
    'SharingReason',
    'SharingRecalculation',
    'SharingRules',
    'SharingSet',
    'SiteDotCom',
    'Skill',
    'StandardValueSet',
    'StandardValueSetTranslation',
    'StaticResource',
    'SynonymDictionary',
    'Territory',
    'Territory2',
    'Territory2Model',
    'Territory2Rule',
    'Territory2Type',
    'TopicsForObjects',
    'TransactionSecurityPolicy',
    'Translations',
    'ValidationRule',
    'WaveApplication',
    'WaveDashboard',
    'WaveDataflow',
    'WaveDataset',
    'WaveLens',
    'WaveTemplateBundle',
    'WaveXmd',
    'WebLink',
    'Workflow'
  };

  @TestVisible
  private static String getSystemProperty(String category, String key, String defaultValue) {
    List<System_Property__mdt> records = [SELECT Id, Value__c FROM System_Property__mdt WHERE Category__c =: category AND Key__c =: key AND Is_Active__c = true LIMIT 1];

    if (records.size() > 0) {
      return records[0].Value__c;
    }

    return defaultValue;
  }

  private static final String SYSPROP_CATEGORY = 'PackBuild';
  private static final String SYSPROP_API_KEY = 'APIVersion';
  private static final String DEFAULT_APIVERSION = '56.0';
  public static final String API_VERSION = getSystemProperty(SYSPROP_CATEGORY, SYSPROP_API_KEY, DEFAULT_APIVERSION);
}
